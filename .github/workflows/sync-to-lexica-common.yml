name: Sync SDOC files to lexica-common

on:
  push:
    branches: [main]
    paths:
      - 'src/sdoc.js'
      - 'src/slide-renderer.js'
      - 'src/slide-pdf.js'
      - 'lexica/sdoc-authoring.sdoc'
      - 'lexica/slide-authoring.sdoc'
      - 'themes/default/**'
      - 'tools/build-slides.js'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sdoc repo
        uses: actions/checkout@v4
        with:
          path: sdoc

      - name: Checkout lexica-common repo
        uses: actions/checkout@v4
        with:
          repository: irreversible-tech/lexica-common
          token: ${{ secrets.LEXICA_COMMON_PAT }}
          path: lexica-common

      - name: Sync files and check for changes
        id: sync
        run: |
          FILES_SUMMARY=""

          # Parser
          cp sdoc/src/sdoc.js lexica-common/server/vendor/sdoc-parser.cjs

          # Slide renderer (patch require path for vendored parser)
          sed 's|require("./sdoc")|require("./sdoc-parser.cjs")|' \
            sdoc/src/slide-renderer.js > lexica-common/server/vendor/slide-renderer.cjs

          # Slide PDF export
          cp sdoc/src/slide-pdf.js lexica-common/server/vendor/slide-pdf.cjs

          # Build tool (patch require paths for vendored layout)
          mkdir -p lexica-common/tools
          sed \
            -e 's|require("../src/sdoc")|require("../server/vendor/sdoc-parser.cjs")|' \
            -e 's|require("../src/slide-renderer")|require("../server/vendor/slide-renderer.cjs")|' \
            -e 's|require("../src/slide-pdf")|require("../server/vendor/slide-pdf.cjs")|' \
            -e 's|"themes", "default"|"presentations", "themes", "default"|' \
            sdoc/tools/build-slides.js > lexica-common/tools/build-slides.cjs

          # Default theme
          mkdir -p lexica-common/presentations/themes/default
          cp sdoc/themes/default/theme.css lexica-common/presentations/themes/default/theme.css
          cp sdoc/themes/default/theme.js lexica-common/presentations/themes/default/theme.js

          # Skill docs
          cp sdoc/lexica/sdoc-authoring.sdoc lexica-common/skills/skill-sdoc.sdoc
          cp sdoc/lexica/slide-authoring.sdoc lexica-common/skills/skill-slides.sdoc

          # Check if anything actually changed
          cd lexica-common
          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
            echo "any_changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "any_changed=true" >> "$GITHUB_OUTPUT"

            # Build summary of changed files
            for f in $(git diff --name-only; git ls-files --others --exclude-standard); do
              FILES_SUMMARY="$FILES_SUMMARY\n- \`$f\`"
            done
          fi

          echo "files_summary=$FILES_SUMMARY" >> "$GITHUB_OUTPUT"

      - name: Commit and open PR
        if: steps.sync.outputs.any_changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.LEXICA_COMMON_PAT }}
        run: |
          cd lexica-common

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch, commit, force-push (reuse branch for consecutive syncs)
          BRANCH="auto/sync-sdoc"
          git checkout -B "$BRANCH"
          git add -A
          git commit -m "Update SDOC files from sdoc repo"
          git push --force origin "$BRANCH"

          # Close any existing PR on this branch, then open a fresh one
          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null || true)
          if [ -n "$EXISTING_PR" ]; then
            gh pr close "$EXISTING_PR" --delete-branch=false
          fi

          gh pr create \
            --title "Update SDOC files from sdoc repo" \
            --body "$(printf "Automated sync from [entropicwarrior/sdoc](https://github.com/entropicwarrior/sdoc).\n\n**Files updated:**\n${{ steps.sync.outputs.files_summary }}\n\nTriggered by commit ${{ github.sha }}.")"
